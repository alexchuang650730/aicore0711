#!/bin/bash

# PowerAutomation 4.0 Ëá™Âä®ÂåñÂÆâË£ÖËÑöÊú¨
# ÈÄÇÁî®‰∫é Ubuntu EC2 ÊúçÂä°Âô®
# ÊúçÂä°Âô®: ec2-44-206-225-192.compute-1.amazonaws.com

set -e  # ÈÅáÂà∞ÈîôËØØÁ´ãÂç≥ÈÄÄÂá∫

echo "üöÄ ÂºÄÂßãÂÆâË£Ö PowerAutomation 4.0..."
echo "ÊúçÂä°Âô®: $(hostname)"
echo "Êó∂Èó¥: $(date)"
echo "Áî®Êà∑: $(whoami)"

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Êó•ÂøóÂáΩÊï∞
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Ê£ÄÊü•ÊòØÂê¶‰∏∫rootÁî®Êà∑
check_root() {
    if [[ $EUID -eq 0 ]]; then
        log_error "ËØ∑‰∏çË¶Å‰ΩøÁî®rootÁî®Êà∑ËøêË°åÊ≠§ËÑöÊú¨"
        exit 1
    fi
}

# Êõ¥Êñ∞Á≥ªÁªü
update_system() {
    log_info "Êõ¥Êñ∞Á≥ªÁªüÂåÖ..."
    sudo apt update -y
    sudo apt upgrade -y
    log_success "Á≥ªÁªüÊõ¥Êñ∞ÂÆåÊàê"
}

# ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ
install_dependencies() {
    log_info "ÂÆâË£ÖÂü∫Á°Ä‰æùËµñ..."
    sudo apt install -y \
        curl \
        wget \
        git \
        unzip \
        software-properties-common \
        apt-transport-https \
        ca-certificates \
        gnupg \
        lsb-release \
        ufw \
        nginx
    log_success "Âü∫Á°Ä‰æùËµñÂÆâË£ÖÂÆåÊàê"
}

# ÂÆâË£ÖNode.js
install_nodejs() {
    log_info "ÂÆâË£ÖNode.js..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    sudo apt install -y nodejs
    
    # È™åËØÅÂÆâË£Ö
    node_version=$(node --version)
    npm_version=$(npm --version)
    log_success "Node.jsÂÆâË£ÖÂÆåÊàê: $node_version, npm: $npm_version"
}

# ÂÆâË£ÖDocker
install_docker() {
    log_info "ÂÆâË£ÖDocker..."
    
    # Ê∑ªÂä†DockerÂÆòÊñπGPGÂØÜÈí•
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
    
    # Ê∑ªÂä†Docker‰ªìÂ∫ì
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
    
    # ÂÆâË£ÖDocker
    sudo apt update -y
    sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
    
    # Â∞ÜÂΩìÂâçÁî®Êà∑Ê∑ªÂä†Âà∞dockerÁªÑ
    sudo usermod -aG docker $USER
    
    # ÂêØÂä®DockerÊúçÂä°
    sudo systemctl start docker
    sudo systemctl enable docker
    
    log_success "DockerÂÆâË£ÖÂÆåÊàê"
}

# ÂÆâË£ÖDocker Compose
install_docker_compose() {
    log_info "ÂÆâË£ÖDocker Compose..."
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
    
    # È™åËØÅÂÆâË£Ö
    compose_version=$(docker-compose --version)
    log_success "Docker ComposeÂÆâË£ÖÂÆåÊàê: $compose_version"
}

# ÈÖçÁΩÆÈò≤ÁÅ´Â¢ô
configure_firewall() {
    log_info "ÈÖçÁΩÆÈò≤ÁÅ´Â¢ô..."
    sudo ufw --force enable
    sudo ufw allow ssh
    sudo ufw allow 80/tcp
    sudo ufw allow 443/tcp
    sudo ufw allow 3000/tcp  # Node.jsÂ∫îÁî®Á´ØÂè£
    log_success "Èò≤ÁÅ´Â¢ôÈÖçÁΩÆÂÆåÊàê"
}

# ÂàõÂª∫Â∫îÁî®ÁõÆÂΩï
create_app_directory() {
    log_info "ÂàõÂª∫Â∫îÁî®ÁõÆÂΩï..."
    sudo mkdir -p /opt/powerautomation
    sudo chown $USER:$USER /opt/powerautomation
    cd /opt/powerautomation
    log_success "Â∫îÁî®ÁõÆÂΩïÂàõÂª∫ÂÆåÊàê: /opt/powerautomation"
}

# ‰∏ãËΩΩPowerAutomationÁΩëÁ´ôÂÜÖÂÆπ
download_website() {
    log_info "‰∏ãËΩΩPowerAutomationÁΩëÁ´ôÂÜÖÂÆπ..."
    
    # ÂàõÂª∫ÁΩëÁ´ôHTMLÊñá‰ª∂
    cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerAutomation 4.0 - Êô∫ËÉΩËá™Âä®ÂåñÂπ≥Âè∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 50px;
        }
        
        .header h1 {
            font-size: 3.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }
        
        .demo-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .demo-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .demo-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .demo-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .demo-card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        .demo-features {
            list-style: none;
            margin-bottom: 25px;
        }
        
        .demo-features li {
            padding: 5px 0;
            color: #555;
            position: relative;
            padding-left: 20px;
        }
        
        .demo-features li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #4CAF50;
            font-weight: bold;
        }
        
        .play-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 50px;
            opacity: 0.8;
        }
        
        /* ËßÜÈ¢ëÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .video-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.3s ease;
        }
        
        .video-modal-content {
            position: relative;
            margin: 5% auto;
            width: 90%;
            max-width: 800px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            animation: slideIn 0.3s ease;
        }
        
        .video-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: relative;
        }
        
        .video-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .video-header p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        
        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
        }
        
        .video-container {
            padding: 20px;
            text-align: center;
        }
        
        .video-player {
            width: 100%;
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }
        
        .video-info {
            margin-top: 15px;
            text-align: left;
        }
        
        .video-info h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .video-info ul {
            list-style: none;
            padding: 0;
        }
        
        .video-info li {
            padding: 5px 0;
            color: #666;
            position: relative;
            padding-left: 20px;
        }
        
        .video-info li::before {
            content: '‚ñ∂';
            position: absolute;
            left: 0;
            color: #667eea;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .demo-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .video-modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PowerAutomation 4.0</h1>
            <p>‰∏ã‰∏Ä‰ª£Êô∫ËÉΩËá™Âä®ÂåñÂπ≥Âè∞ - ÈáçÊñ∞ÂÆö‰πâÂ∑•‰ΩúÊµÅÁ®ã</p>
        </div>
        
        <div class="demo-grid" id="demo">
            <div class="demo-card">
                <h3>SmartUI + MemoryOS</h3>
                <p>Êô∫ËÉΩÁïåÈù¢Ëá™ÈÄÇÂ∫î‰∏éÈïøÊúüËÆ∞ÂøÜÁ≥ªÁªüÔºåËÆ©AIÁúüÊ≠£ÁêÜËß£Áî®Êà∑‰π†ÊÉØ</p>
                <ul class="demo-features">
                    <li>SmartUIÊô∫ËÉΩËá™ÈÄÇÂ∫îÁïåÈù¢</li>
                    <li>MemoryOSÈïøÊúüËÆ∞ÂøÜÁ≥ªÁªü</li>
                    <li>49.11%ÊÄßËÉΩÊèêÂçá</li>
                    <li>‰∏™ÊÄßÂåñÁî®Êà∑‰ΩìÈ™å</li>
                </ul>
                <button class="play-btn" onclick="playDemo('smartui')">Êí≠ÊîæÊºîÁ§∫</button>
            </div>
            
            <div class="demo-card">
                <h3>MCPÂ∑•ÂÖ∑ÂèëÁé∞</h3>
                <p>Èù©ÂëΩÊÄßÁöÑMCP-ZeroÂºïÊìéÔºåÊô∫ËÉΩÂèëÁé∞ÂíåÊé®ËçêÊúÄÈÄÇÂêàÁöÑÂ∑•ÂÖ∑</p>
                <ul class="demo-features">
                    <li>MCP-ZeroÊô∫ËÉΩÂºïÊìé</li>
                    <li>14ÁßçÂ∑•ÂÖ∑Ëá™Âä®ÂèëÁé∞</li>
                    <li>Êô∫ËÉΩÂåπÈÖçÊé®Ëçê</li>
                    <li>Èõ∂ÈÖçÁΩÆÂç≥Áî®</li>
                </ul>
                <button class="play-btn" onclick="playDemo('mcp')">Êí≠ÊîæÊºîÁ§∫</button>
            </div>
            
            <div class="demo-card">
                <h3>Á´Ø‰∫ëÂ§öÊ®°ÂûãÂçèÂêå</h3>
                <p>Claude 3.5 Sonnet‰∏éGemini 1.5 ProÊô∫ËÉΩÂçèÂêåÔºåÊÄßËÉΩÁøªÂÄç</p>
                <ul class="demo-features">
                    <li>Claude 3.5 SonnetÈõÜÊàê</li>
                    <li>Gemini 1.5 ProÂçèÂêå</li>
                    <li>Êô∫ËÉΩÊ®°ÂûãÂàáÊç¢</li>
                    <li>ÊÄßËÉΩ‰ºòÂåñÁÆóÊ≥ï</li>
                </ul>
                <button class="play-btn" onclick="playDemo('multimodel')">Êí≠ÊîæÊºîÁ§∫</button>
            </div>
            
            <div class="demo-card">
                <h3>Á´ØÂà∞Á´ØËá™Âä®ÂåñÊµãËØï</h3>
                <p>Stagewise MCP‰∏éÂΩïÂà∂Âç≥ÊµãËØïÊäÄÊúØÔºåÂÆûÁé∞ÁúüÊ≠£ÁöÑÁ´ØÂà∞Á´ØËá™Âä®Âåñ</p>
                <ul class="demo-features">
                    <li>Stagewise MCPÊû∂ÊûÑ</li>
                    <li>ÂΩïÂà∂Âç≥ÊµãËØïÊäÄÊúØ</li>
                    <li>Á´ØÂà∞Á´ØËá™Âä®Âåñ</li>
                    <li>Êô∫ËÉΩÊµãËØïÁîüÊàê</li>
                </ul>
                <button class="play-btn" onclick="playDemo('e2e')">Êí≠ÊîæÊºîÁ§∫</button>
            </div>
        </div>
        
        <div class="footer">
            <p>&copy; 2024 PowerAutomation 4.0 - Êô∫ËÉΩËá™Âä®ÂåñÁöÑÊú™Êù•</p>
        </div>
    </div>
    
    <!-- ËßÜÈ¢ëÊ®°ÊÄÅÊ°Ü -->
    <div id="videoModal" class="video-modal">
        <div class="video-modal-content">
            <div class="video-header">
                <h3 id="videoTitle">ÊºîÁ§∫Ê†áÈ¢ò</h3>
                <p id="videoDescription">ÊºîÁ§∫ÊèèËø∞</p>
                <button class="close-btn" onclick="closeVideoModal()">&times;</button>
            </div>
            <div class="video-container">
                <video id="videoPlayer" class="video-player" controls>
                    <source id="videoSource" src="" type="video/mp4">
                    ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅËßÜÈ¢ëÊí≠Êîæ„ÄÇ
                </video>
                <div class="video-info">
                    <h4>ÂäüËÉΩ‰∫ÆÁÇπ:</h4>
                    <ul id="videoFeatures">
                        <!-- Âä®ÊÄÅÁîüÊàêÂäüËÉΩÂàóË°® -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ÊºîÁ§∫ÈÖçÁΩÆ
        const demoConfig = {
            smartui: {
                title: "SmartUI + MemoryOSÊºîÁ§∫",
                description: "Êô∫ËÉΩÁïåÈù¢‰∏éÈïøÊúüËÆ∞ÂøÜÁ≥ªÁªüÔºå49.11%ÊÄßËÉΩÊèêÂçá",
                videoUrl: "/demo_videos/tc_demo_001_recorded.mp4",
                features: [
                    "SmartUIÊô∫ËÉΩËá™ÈÄÇÂ∫îÁïåÈù¢Ë∞ÉÊï¥",
                    "MemoryOSÈïøÊúüËÆ∞ÂøÜÁ≥ªÁªüÁÆ°ÁêÜ",
                    "49.11%ÊÄª‰ΩìÊÄßËÉΩÊèêÂçá",
                    "‰∏™ÊÄßÂåñÁî®Êà∑‰ΩìÈ™å‰ºòÂåñ"
                ]
            },
            mcp: {
                title: "MCPÂ∑•ÂÖ∑ÂèëÁé∞ÊºîÁ§∫",
                description: "MCP-ZeroÂºïÊìéÊô∫ËÉΩÂ∑•ÂÖ∑ÂèëÁé∞‰∏éÊé®Ëçê",
                videoUrl: "/demo_videos/tc_demo_002.mp4",
                features: [
                    "MCP-ZeroÊô∫ËÉΩÂºïÊìé",
                    "14ÁßçÂ∑•ÂÖ∑Ëá™Âä®ÂèëÁé∞",
                    "Êô∫ËÉΩÂåπÈÖçÊé®ËçêÁÆóÊ≥ï",
                    "Èõ∂ÈÖçÁΩÆÂç≥Áî®‰ΩìÈ™å"
                ]
            },
            multimodel: {
                title: "Á´Ø‰∫ëÂ§öÊ®°ÂûãÂçèÂêåÊºîÁ§∫",
                description: "Claude 3.5 Sonnet‰∏éGemini 1.5 ProÊô∫ËÉΩÂçèÂêå",
                videoUrl: "/demo_videos/tc_demo_003.mp4",
                features: [
                    "Claude 3.5 SonnetÊ∑±Â∫¶ÈõÜÊàê",
                    "Gemini 1.5 ProÂçèÂêåÂ§ÑÁêÜ",
                    "Êô∫ËÉΩÊ®°ÂûãËá™Âä®ÂàáÊç¢",
                    "ÊÄßËÉΩ‰ºòÂåñÁÆóÊ≥ï"
                ]
            },
            e2e: {
                title: "Á´ØÂà∞Á´ØËá™Âä®ÂåñÊµãËØïÊºîÁ§∫",
                description: "Stagewise MCP‰∏éÂΩïÂà∂Âç≥ÊµãËØïÊäÄÊúØ",
                videoUrl: "/demo_videos/tc_demo_004.mp4",
                features: [
                    "Stagewise MCPÊû∂ÊûÑ",
                    "ÂΩïÂà∂Âç≥ÊµãËØïÊäÄÊúØ",
                    "Á´ØÂà∞Á´ØËá™Âä®ÂåñÊµÅÁ®ã",
                    "Êô∫ËÉΩÊµãËØïÁî®‰æãÁîüÊàê"
                ]
            }
        };
        
        // Êí≠ÊîæÊºîÁ§∫ÂáΩÊï∞
        function playDemo(demoType) {
            const config = demoConfig[demoType];
            if (!config) {
                alert('ÊºîÁ§∫ÊöÇÊó∂‰∏çÂèØÁî®');
                return;
            }
            
            // ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπ
            document.getElementById('videoTitle').textContent = config.title;
            document.getElementById('videoDescription').textContent = config.description;
            document.getElementById('videoSource').src = config.videoUrl;
            
            // ËÆæÁΩÆÂäüËÉΩÂàóË°®
            const featuresContainer = document.getElementById('videoFeatures');
            featuresContainer.innerHTML = '';
            config.features.forEach(feature => {
                const li = document.createElement('li');
                li.textContent = feature;
                featuresContainer.appendChild(li);
            });
            
            // ÈáçÊñ∞Âä†ËΩΩËßÜÈ¢ë
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.load();
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('videoModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        
        // ÂÖ≥Èó≠ËßÜÈ¢ëÊ®°ÊÄÅÊ°Ü
        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const videoPlayer = document.getElementById('videoPlayer');
            
            // ÊöÇÂÅúËßÜÈ¢ë
            videoPlayer.pause();
            videoPlayer.currentTime = 0;
            
            // ÈöêËóèÊ®°ÊÄÅÊ°Ü
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
        document.getElementById('videoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVideoModal();
            }
        });
        
        // ESCÈîÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeVideoModal();
            }
        });
        
        // Á©∫Ê†ºÈîÆÊéßÂà∂Êí≠Êîæ/ÊöÇÂÅú
        document.addEventListener('keydown', function(e) {
            if (e.key === ' ' && document.getElementById('videoModal').style.display === 'block') {
                e.preventDefault();
                const videoPlayer = document.getElementById('videoPlayer');
                if (videoPlayer.paused) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            }
        });
        
        console.log('PowerAutomation 4.0 ÊºîÁ§∫Á≥ªÁªüÂ∑≤Âä†ËΩΩ');
        console.log('ÊîØÊåÅÁöÑÊºîÁ§∫Á±ªÂûã:', Object.keys(demoConfig));
    </script>
</body>
</html>
EOF
    
    log_success "ÁΩëÁ´ôÂÜÖÂÆπÂàõÂª∫ÂÆåÊàê"
}

# ÂàõÂª∫Node.jsÊúçÂä°Âô®
create_nodejs_server() {
    log_info "ÂàõÂª∫Node.jsÊúçÂä°Âô®..."
    
    # ÂàõÂª∫package.json
    cat > package.json << 'EOF'
{
  "name": "powerautomation-website",
  "version": "1.0.0",
  "description": "PowerAutomation 4.0 ÂÆòÊñπÁΩëÁ´ô",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "pm2:start": "pm2 start server.js --name powerautomation",
    "pm2:stop": "pm2 stop powerautomation",
    "pm2:restart": "pm2 restart powerautomation"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "helmet": "^7.1.0",
    "compression": "^1.7.4"
  },
  "devDependencies": {
    "nodemon": "^3.0.2"
  },
  "keywords": ["powerautomation", "automation", "ai"],
  "author": "PowerAutomation Team",
  "license": "MIT"
}
EOF
    
    # ÂàõÂª∫ÊúçÂä°Âô®Êñá‰ª∂
    cat > server.js << 'EOF'
const express = require('express');
const path = require('path');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');

const app = express();
const PORT = process.env.PORT || 3000;

// ÂÆâÂÖ®‰∏≠Èó¥‰ª∂
app.use(helmet({
    contentSecurityPolicy: {
        directives: {
            defaultSrc: ["'self'"],
            styleSrc: ["'self'", "'unsafe-inline'"],
            scriptSrc: ["'self'", "'unsafe-inline'"],
            imgSrc: ["'self'", "data:", "https:"],
            mediaSrc: ["'self'"],
            fontSrc: ["'self'"]
        }
    }
}));

// CORSÈÖçÁΩÆ
app.use(cors());

// ÂéãÁº©ÂìçÂ∫î
app.use(compression());

// ÈùôÊÄÅÊñá‰ª∂ÊúçÂä°
app.use(express.static('.', {
    maxAge: '1d',
    etag: true
}));

// ÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπ
app.get('/health', (req, res) => {
    res.json({
        status: 'healthy',
        timestamp: new Date().toISOString(),
        uptime: process.uptime(),
        version: '1.0.0'
    });
});

// ‰∏ªÈ°µË∑ØÁî±
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

// 404Â§ÑÁêÜ
app.use((req, res) => {
    res.status(404).json({
        error: 'Page not found',
        path: req.path
    });
});

// ÈîôËØØÂ§ÑÁêÜ
app.use((err, req, res, next) => {
    console.error('Server error:', err);
    res.status(500).json({
        error: 'Internal server error'
    });
});

// ÂêØÂä®ÊúçÂä°Âô®
app.listen(PORT, '0.0.0.0', () => {
    console.log(`üöÄ PowerAutomation 4.0 ÊúçÂä°Âô®ËøêË°åÂú®Á´ØÂè£ ${PORT}`);
    console.log(`üì± Êú¨Âú∞ËÆøÈóÆ: http://localhost:${PORT}`);
    console.log(`üåê Â§ñÈÉ®ËÆøÈóÆ: http://$(hostname -I | awk '{print $1}'):${PORT}`);
    console.log(`üíö ÂÅ•Â∫∑Ê£ÄÊü•: http://localhost:${PORT}/health`);
});

// ‰ºòÈõÖÂÖ≥Èó≠
process.on('SIGTERM', () => {
    console.log('Êî∂Âà∞SIGTERM‰ø°Âè∑ÔºåÊ≠£Âú®ÂÖ≥Èó≠ÊúçÂä°Âô®...');
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('Êî∂Âà∞SIGINT‰ø°Âè∑ÔºåÊ≠£Âú®ÂÖ≥Èó≠ÊúçÂä°Âô®...');
    process.exit(0);
});
EOF
    
    log_success "Node.jsÊúçÂä°Âô®ÂàõÂª∫ÂÆåÊàê"
}

# ÂÆâË£ÖNode.js‰æùËµñ
install_npm_dependencies() {
    log_info "ÂÆâË£ÖNode.js‰æùËµñ..."
    npm install
    log_success "Node.js‰æùËµñÂÆâË£ÖÂÆåÊàê"
}

# ÂàõÂª∫ÊºîÁ§∫ËßÜÈ¢ëÁõÆÂΩï
create_demo_videos_directory() {
    log_info "ÂàõÂª∫ÊºîÁ§∫ËßÜÈ¢ëÁõÆÂΩï..."
    mkdir -p demo_videos
    
    # ÂàõÂª∫Âç†‰ΩçÁ¨¶ËßÜÈ¢ëÊñá‰ª∂ÔºàÂÆûÈôÖÈÉ®ÁΩ≤Êó∂ÈúÄË¶ÅÊõøÊç¢‰∏∫ÁúüÂÆûËßÜÈ¢ëÔºâ
    log_warning "Ê≥®ÊÑè: ÊºîÁ§∫ËßÜÈ¢ëÊñá‰ª∂ÈúÄË¶ÅÊâãÂä®‰∏ä‰º†Âà∞ demo_videos/ ÁõÆÂΩï"
    log_info "ÈúÄË¶ÅÁöÑËßÜÈ¢ëÊñá‰ª∂:"
    echo "  - tc_demo_001_recorded.mp4 (SmartUI + MemoryOS)"
    echo "  - tc_demo_002.mp4 (MCPÂ∑•ÂÖ∑ÂèëÁé∞)"
    echo "  - tc_demo_003.mp4 (Á´Ø‰∫ëÂ§öÊ®°ÂûãÂçèÂêå)"
    echo "  - tc_demo_004.mp4 (Á´ØÂà∞Á´ØËá™Âä®ÂåñÊµãËØï)"
    
    log_success "ÊºîÁ§∫ËßÜÈ¢ëÁõÆÂΩïÂàõÂª∫ÂÆåÊàê"
}

# ÈÖçÁΩÆNginx
configure_nginx() {
    log_info "ÈÖçÁΩÆNginx..."
    
    # ÂàõÂª∫NginxÈÖçÁΩÆ
    sudo tee /etc/nginx/sites-available/powerautomation << 'EOF'
server {
    listen 80;
    server_name _;
    
    # ÂÆâÂÖ®Â§¥
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # ÂèçÂêë‰ª£ÁêÜÂà∞Node.jsÂ∫îÁî®
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Ë∂ÖÊó∂ËÆæÁΩÆ
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # ÈùôÊÄÅÊñá‰ª∂ÁºìÂ≠ò
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://localhost:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # ËßÜÈ¢ëÊñá‰ª∂ÁâπÊÆäÂ§ÑÁêÜ
    location /demo_videos/ {
        proxy_pass http://localhost:3000;
        proxy_buffering off;
        add_header Cache-Control "public, max-age=3600";
    }
    
    # ÂÅ•Â∫∑Ê£ÄÊü•
    location /health {
        proxy_pass http://localhost:3000;
        access_log off;
    }
}
EOF
    
    # ÂêØÁî®Á´ôÁÇπ
    sudo ln -sf /etc/nginx/sites-available/powerautomation /etc/nginx/sites-enabled/
    sudo rm -f /etc/nginx/sites-enabled/default
    
    # ÊµãËØïNginxÈÖçÁΩÆ
    sudo nginx -t
    
    # ÈáçÂêØNginx
    sudo systemctl restart nginx
    sudo systemctl enable nginx
    
    log_success "NginxÈÖçÁΩÆÂÆåÊàê"
}

# ÂàõÂª∫Á≥ªÁªüÊúçÂä°
create_systemd_service() {
    log_info "ÂàõÂª∫Á≥ªÁªüÊúçÂä°..."
    
    sudo tee /etc/systemd/system/powerautomation.service << EOF
[Unit]
Description=PowerAutomation 4.0 Website
Documentation=https://powerautomation.com
After=network.target

[Service]
Type=simple
User=$USER
WorkingDirectory=/opt/powerautomation
Environment=NODE_ENV=production
Environment=PORT=3000
ExecStart=/usr/bin/node server.js
Restart=on-failure
RestartSec=10
KillMode=mixed
KillSignal=SIGTERM
TimeoutStopSec=5

# ÂÆâÂÖ®ËÆæÁΩÆ
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/powerautomation

# Êó•ÂøóËÆæÁΩÆ
StandardOutput=journal
StandardError=journal
SyslogIdentifier=powerautomation

[Install]
WantedBy=multi-user.target
EOF
    
    # ÈáçÊñ∞Âä†ËΩΩsystemd
    sudo systemctl daemon-reload
    sudo systemctl enable powerautomation
    
    log_success "Á≥ªÁªüÊúçÂä°ÂàõÂª∫ÂÆåÊàê"
}

# ÂêØÂä®ÊúçÂä°
start_services() {
    log_info "ÂêØÂä®ÊúçÂä°..."
    
    # ÂêØÂä®PowerAutomationÊúçÂä°
    sudo systemctl start powerautomation
    
    # Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ
    sleep 3
    if sudo systemctl is-active --quiet powerautomation; then
        log_success "PowerAutomationÊúçÂä°ÂêØÂä®ÊàêÂäü"
    else
        log_error "PowerAutomationÊúçÂä°ÂêØÂä®Â§±Ë¥•"
        sudo systemctl status powerautomation
        exit 1
    fi
    
    # Ê£ÄÊü•NginxÁä∂ÊÄÅ
    if sudo systemctl is-active --quiet nginx; then
        log_success "NginxÊúçÂä°ËøêË°åÊ≠£Â∏∏"
    else
        log_error "NginxÊúçÂä°ÂºÇÂ∏∏"
        sudo systemctl status nginx
        exit 1
    fi
}

# È™åËØÅÂÆâË£Ö
verify_installation() {
    log_info "È™åËØÅÂÆâË£Ö..."
    
    # Ëé∑ÂèñÊúçÂä°Âô®IP
    SERVER_IP=$(curl -s http://checkip.amazonaws.com/ || hostname -I | awk '{print $1}')
    
    # ÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•
    if curl -s http://localhost:3000/health > /dev/null; then
        log_success "Â∫îÁî®ÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøá"
    else
        log_error "Â∫îÁî®ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•"
        exit 1
    fi
    
    # ÊµãËØïNginx‰ª£ÁêÜ
    if curl -s http://localhost/ > /dev/null; then
        log_success "Nginx‰ª£ÁêÜÊµãËØïÈÄöËøá"
    else
        log_error "Nginx‰ª£ÁêÜÊµãËØïÂ§±Ë¥•"
        exit 1
    fi
    
    log_success "ÂÆâË£ÖÈ™åËØÅÂÆåÊàê"
    
    echo ""
    echo "üéâ PowerAutomation 4.0 ÂÆâË£ÖÂÆåÊàêÔºÅ"
    echo ""
    echo "üì± ËÆøÈóÆÂú∞ÂùÄ:"
    echo "   http://$SERVER_IP"
    echo "   http://localhost"
    echo ""
    echo "üîß ÁÆ°ÁêÜÂëΩ‰ª§:"
    echo "   sudo systemctl status powerautomation    # Êü•ÁúãÊúçÂä°Áä∂ÊÄÅ"
    echo "   sudo systemctl restart powerautomation   # ÈáçÂêØÊúçÂä°"
    echo "   sudo systemctl logs powerautomation      # Êü•ÁúãÊó•Âøó"
    echo ""
    echo "üìÅ Â∫îÁî®ÁõÆÂΩï: /opt/powerautomation"
    echo "üìπ ËßÜÈ¢ëÁõÆÂΩï: /opt/powerautomation/demo_videos"
    echo ""
    echo "‚ö†Ô∏è  ÈáçË¶ÅÊèêÈÜí:"
    echo "   ËØ∑Â∞ÜÊºîÁ§∫ËßÜÈ¢ëÊñá‰ª∂‰∏ä‰º†Âà∞ /opt/powerautomation/demo_videos/ ÁõÆÂΩï"
    echo "   ÈúÄË¶ÅÁöÑÊñá‰ª∂: tc_demo_001_recorded.mp4, tc_demo_002.mp4, tc_demo_003.mp4, tc_demo_004.mp4"
    echo ""
}

# ‰∏ªÂáΩÊï∞
main() {
    echo "üöÄ PowerAutomation 4.0 Ëá™Âä®ÂåñÂÆâË£ÖÂºÄÂßã..."
    echo "================================================"
    
    check_root
    update_system
    install_dependencies
    install_nodejs
    install_docker
    install_docker_compose
    configure_firewall
    create_app_directory
    download_website
    create_nodejs_server
    install_npm_dependencies
    create_demo_videos_directory
    configure_nginx
    create_systemd_service
    start_services
    verify_installation
    
    echo "================================================"
    echo "‚úÖ PowerAutomation 4.0 ÂÆâË£ÖÂÆåÊàêÔºÅ"
}

# ÊâßË°å‰∏ªÂáΩÊï∞
main "$@"

